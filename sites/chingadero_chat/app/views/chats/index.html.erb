<div class="flex gap-4 w-full h-[92vh]">

  <!-- Sidebar: Conversation List -->
  <div class="w-56 flex-shrink-0 bg-zinc-800 rounded-2xl shadow-xl flex flex-col overflow-hidden border border-zinc-700">
    <div class="p-3 border-b border-zinc-700">
      <%= button_to conversations_path, method: :post,
            class: "w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-xl px-3 py-2 transition-colors" do %>
        + New Chat
      <% end %>
    </div>

    <div class="flex-grow overflow-y-auto p-2 flex flex-col gap-1">
      <% @conversations.each do |conv| %>
        <% active = conv.id == @conversation.id %>
        <div class="group flex items-center gap-1">
          <%= link_to chats_path(conversation_id: conv.id),
                class: "flex-grow min-w-0 px-3 py-2 rounded-xl text-sm transition-colors #{active ? 'bg-zinc-700 text-zinc-100 font-medium' : 'text-zinc-400 hover:bg-zinc-700 hover:text-zinc-100'}" do %>
            <div class="truncate"><%= conv.title.present? ? conv.title : "New conversation" %></div>
            <div class="text-xs text-zinc-500 mt-0.5"><%= conv.created_at.strftime("%b %-d") %></div>
          <% end %>
          <%= button_to conversation_path(conv), method: :delete,
                class: "opacity-0 group-hover:opacity-100 flex-shrink-0 p-1.5 rounded-lg text-zinc-500 hover:text-red-400 hover:bg-zinc-700 transition-all",
                data: { confirm: "Delete this conversation?" } do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3.5 h-3.5">
              <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.07a3 3 0 01-2.991 2.77H8.084a3 3 0 01-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452zm-.355 5.945a.75.75 0 10-1.5.058l.347 9a.75.75 0 101.499-.058l-.346-9zm5.48.058a.75.75 0 10-1.498-.058l-.347 9a.75.75 0 001.5.058l.345-9z" clip-rule="evenodd" />
            </svg>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Main Chat Panel -->
  <div class="flex-grow bg-zinc-800 rounded-2xl shadow-xl flex flex-col overflow-hidden border border-zinc-700">

    <!-- Header -->
    <header class="bg-zinc-800 px-6 py-4 border-b border-zinc-700 flex items-center flex-wrap gap-3">
      <div class="bg-gradient-to-br from-blue-400 to-blue-700 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-sm flex-shrink-0">
        <!-- Martini glass: wide V bowl narrowing to near-point, thin stem, flat base -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
          <path d="M3 3h18L12.5 15v4h2.5v2h-6v-2h2.5v-4L3 3z"/>
        </svg>
      </div>
      <h2 class="m-0 text-lg font-semibold text-zinc-100 truncate">
        <%= @conversation.title.present? ? @conversation.title : "New conversation" %>
      </h2>
      <!-- AI Model Toggle -->
      <div class="ml-auto flex items-center gap-2">
        <% if @ai_model == 'claude' %>
          <div class="flex items-center gap-1 bg-zinc-700 rounded-full p-1 border border-zinc-600">
            <%= button_to session_path, method: :patch,
                  params: { claude_model: 'sonnet' },
                  class: "px-3 py-1 rounded-full text-xs font-medium transition-colors #{@claude_model == 'sonnet' ? 'bg-zinc-500 text-white shadow-sm' : 'text-zinc-400 hover:text-zinc-100'}" do %>
              Sonnet
            <% end %>
            <%= button_to session_path, method: :patch,
                  params: { claude_model: 'opus' },
                  class: "px-3 py-1 rounded-full text-xs font-medium transition-colors #{@claude_model == 'opus' ? 'bg-zinc-500 text-white shadow-sm' : 'text-zinc-400 hover:text-zinc-100'}" do %>
              Opus
            <% end %>
          </div>
        <% end %>
        <div class="flex items-center gap-1 bg-zinc-700 rounded-full p-1 border border-zinc-600">
          <%= button_to session_path, method: :patch,
                params: { ai_model: 'gemini' },
                class: "px-3 py-1 rounded-full text-sm font-medium transition-colors #{@ai_model == 'gemini' ? 'bg-blue-600 text-white shadow-sm' : 'text-zinc-400 hover:text-zinc-100'}" do %>
            Gemini
          <% end %>
          <%= button_to session_path, method: :patch,
                params: { ai_model: 'claude' },
                class: "px-3 py-1 rounded-full text-sm font-medium transition-colors #{@ai_model == 'claude' ? 'bg-blue-600 text-white shadow-sm' : 'text-zinc-400 hover:text-zinc-100'}" do %>
            Claude
          <% end %>
        </div>
      </div>

      <!-- Generate Image: David bust icon -->
      <%= link_to new_image_path, class: "flex items-center gap-1.5 text-sm text-blue-400 hover:text-blue-300" do %>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10">
          <!-- Curly hair: 3 bumps -->
          <path d="M8.5 9Q9 4 9.5 4.5Q10.5 6 10.5 7.5Q11 4 12 3.5Q13 4 13.5 7.5Q13.5 6 14.5 4.5Q15 4 15.5 9Q14 8.5 12 8.5Q10 8.5 8.5 9Z"/>
          <!-- Head -->
          <circle cx="12" cy="10.2" r="3.3"/>
          <!-- Neck -->
          <path d="M11 13.5h2v1.5h-2z"/>
          <!-- Toga / shoulders -->
          <path d="M7 15C8.5 14.3 10.5 14 12 14s3.5.3 5 1v3H7v-3z"/>
        </svg>
        Generate Image
      <% end %>
    </header>

    <!-- Chat History -->
    <div class="flex-grow p-6 overflow-y-auto bg-zinc-900 flex flex-col gap-5" id="chat-messages">
      <% if @messages.empty? %>
        <div class="text-center text-zinc-500 mt-10">
          <p>Send a message to start the conversation!</p>
        </div>
      <% end %>

      <% @messages.each do |msg| %>
        <div class="flex items-end gap-2 w-full <%= msg.role == 'user' ? 'justify-end' : 'justify-start' %>">

          <% if msg.role == 'model' %>
            <div class="bg-gradient-to-br from-blue-400 to-blue-700 text-white w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                <path d="M3 3h18L12.5 15v4h2.5v2h-6v-2h2.5v-4L3 3z"/>
              </svg>
            </div>
          <% end %>

          <div class="max-w-[80%] px-4 py-3 text-[15px] leading-relaxed <%= msg.role == 'user' ? 'bg-blue-600 text-white rounded-2xl rounded-br-sm shadow-md' : 'bg-zinc-700 text-zinc-100 rounded-2xl rounded-bl-sm border border-zinc-600 shadow-sm' %>">
            <%= simple_format(msg.content, class: "mb-0 [&>p]:mb-2[&>p:last-child]:mb-0") %>
          </div>

        </div>
      <% end %>
    </div>

    <!-- Input Form -->
    <div class="p-4 bg-zinc-800 border-t border-zinc-700">
      <%= form_with url: chats_path, local: true, class: "flex gap-2 bg-zinc-700 border border-zinc-600 rounded-full p-1.5 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-all" do |f| %>

        <%= f.text_field :content,
                         placeholder: "Message #{@ai_model == 'claude' ? 'Claude' : 'Gemini'}...",
                         class: "flex-grow bg-transparent border-none focus:ring-0 text-zinc-100 placeholder-zinc-400 px-4 py-2 outline-none",
                         required: true,
                         autocomplete: 'off',
                         autofocus: true %>

        <%= button_tag type: 'submit', class: "bg-blue-600 hover:bg-blue-700 text-white rounded-full w-10 h-10 flex items-center justify-center transition-colors flex-shrink-0" do %>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 ml-1">
            <path d="M3.478 2.404a.75.75 0 00-.926.941l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.404z" />
          </svg>
        <% end %>
      <% end %>
    </div>

  </div>
</div>

<!-- Auto-Scroll JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const chatMessages = document.getElementById("chat-messages");
    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  });
</script>
