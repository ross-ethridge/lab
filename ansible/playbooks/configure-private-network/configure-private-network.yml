---
- name: Configure private network on rpm1
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Ensure netplan configuration directory exists
      ansible.builtin.file:
        path: /etc/netplan
        state: directory
        mode: "0755"

    - name: Create Netplan configuration from template
      ansible.builtin.template:
        src: templates/01-private.yaml.j2
        dest: /etc/netplan/50-cloud-init.yaml
        owner: root
        group: root
        mode: "0600"
      register: netplan_template
      vars:
        network_interface: enp2s0
        private_ip: "{{ vault[inventory_hostname].private_ip }}"

    - name: Apply the netplan configuration
      ansible.builtin.command: netplan apply
      register: netplan_apply
      ignore_errors: false
      changed_when: netplan_template.changed

    - name: Verify netplan configuration applied successfully
      ansible.builtin.debug:
        msg: "Netplan applied: {{ netplan_apply.stdout }}"
      changed_when: netplan_apply.changed
