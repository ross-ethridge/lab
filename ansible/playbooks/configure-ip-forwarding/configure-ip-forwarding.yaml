---
- name: Configure IP forwarding on nodes
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Check if IP forwarding is already enabled and uncommented
      ansible.builtin.lineinfile:
        path: /etc/sysctl.conf
        regexp: '^net\.ipv4\.ip_forward\s*=\s*1'
        line: "net.ipv4.ip_forward = 1"
        state: present
      check_mode: true
      changed_when: false
      register: ip_forward_check

    - name: Ensure br_netfilter module is loaded on boot
      ansible.builtin.lineinfile:
        path: /etc/modules-load.d/modules.conf
        line: "br_netfilter"
        state: present
      register: br_netfilter_line

    - name: Ensure bridge module is loaded on boot
      ansible.builtin.lineinfile:
        path: /etc/modules-load.d/modules.conf
        line: "bridge"
        state: present
      register: bridge_line

    - name: Ensure overlay module is loaded on boot
      ansible.builtin.lineinfile:
        path: /etc/modules-load.d/modules.conf
        line: "overlay"
        state: present
      register: overlay_line

    - name: Load br_netfilter module and enable IP forwarding
      ansible.builtin.shell: |
        sudo modprobe br_netfilter
        sudo modprobe bridge
        sudo modprobe overlay
      args:
        executable: /bin/bash
      changed_when: true


    - name: Configure IP forwarding
      ansible.builtin.lineinfile:
        path: /etc/sysctl.conf
        regexp: '^net\.ipv4\.ip_forward\s*='
        line: "net.ipv4.ip_forward = 1"
        state: present

    - name: Configure bridge netfilter
      ansible.builtin.lineinfile:
        path: /etc/sysctl.conf
        regexp: '^net\.bridge\.bridge-nf-call-iptables\s*='
        line: "net.bridge.bridge-nf-call-iptables = 1"
        state: present

    - name: Apply sysctl configuration
      ansible.builtin.command: sysctl -p /etc/sysctl.conf
      changed_when: true
